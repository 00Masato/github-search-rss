{
    "version": "https://jsonfeed.org/version/1",
    "title": "rails/rails pr",
    "home_page_url": "https://00masato.github.io/github-search-rss/rails-pr.json",
    "feed_url": "https://00masato.github.io/github-search-rss/rails-pr.json",
    "description": "rails/rails pr on GitHub",
    "items": [
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/674321?u=784b6dfff67d37694fa5f914a25273855a065e79&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">When building a new Service for ActiveStorage, we got two requirements:</p>\n<ol dir=\"auto\">\n<li>We need to direct upload a file with <code class=\"notranslate\">POST</code> method instead of <code class=\"notranslate\">PUT</code>, and send credential(token), key(filename) and file(binary to upload) with <code class=\"notranslate\">Content-Type:   multipart/form-data; boundary=&lt;frontier&gt;</code>, instead of sending them with headers.</li>\n<li>We are creating a SaaS that make each Tenant has their own Cloud Service configuration, hence it's not possible to write all service configurations into <code class=\"notranslate\">config/storage.yml</code>. For now, <code class=\"notranslate\">ActiveStorage::Blob</code> has an anonymous validator to check <code class=\"notranslate\">service_name</code> has to be declared in <code class=\"notranslate\">ActiveStorage::Blob.services</code>, we can't disable this validator.</li>\n</ol>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\"><strong>I think it's better to make them configurable like this:</strong></p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# write my own service\nmodule ActiveStorage\n  class Service::QiniumService &lt; Service\n\n    # declare direct upload with HTTP POST method\n    def http_method_for_direct_upload\n      'POST'\n    end\n\n   # declare direct upload response type, &quot;text&quot; or &quot;json&quot;\n    def http_response_type_for_direct_upload\n      'json'\n    end\n\n    # declare direct upload file as multipart/form-data, the value of ':file' is the form data key to file\n    def form_data_for_direct_upload(key, expires_in:, content_type:, content_length:, checksum:, **)\n      put_policy = Qinium::PutPolicy.new(config, key: key, expires_in: expires_in)\n      put_policy.fsize_limit = content_length.to_i + 1000\n      put_policy.mime_limit = content_type\n      put_policy.detect_mime = 1\n      put_policy.insert_only = 1\n      {\n        key: key,\n        token: put_policy.to_token,\n        ':file': 'file'\n      }\n    end\nend\"><pre class=\"notranslate\"><span class=\"pl-c\"># write my own service</span>\n<span class=\"pl-k\">module</span> <span class=\"pl-v\">ActiveStorage</span>\n  <span class=\"pl-k\">class</span> <span class=\"pl-v\">Service</span>::<span class=\"pl-v\">QiniumService</span> &lt; <span class=\"pl-v\">Service</span>\n\n    <span class=\"pl-c\"># declare direct upload with HTTP POST method</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">http_method_for_direct_upload</span>\n      <span class=\"pl-s\">'POST'</span>\n    <span class=\"pl-k\">end</span>\n\n   <span class=\"pl-c\"># declare direct upload response type, \"text\" or \"json\"</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">http_response_type_for_direct_upload</span>\n      <span class=\"pl-s\">'json'</span>\n    <span class=\"pl-k\">end</span>\n\n    <span class=\"pl-c\"># declare direct upload file as multipart/form-data, the value of ':file' is the form data key to file</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">form_data_for_direct_upload</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">key</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">expires_in</span>:<span class=\"pl-kos\">,</span> <span class=\"pl-s1\">content_type</span>:<span class=\"pl-kos\">,</span> <span class=\"pl-s1\">content_length</span>:<span class=\"pl-kos\">,</span> <span class=\"pl-s1\">checksum</span>:<span class=\"pl-kos\">,</span> **<span class=\"pl-kos\">)</span>\n      <span class=\"pl-s1\">put_policy</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Qinium</span>::<span class=\"pl-v\">PutPolicy</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">config</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">key</span>: <span class=\"pl-s1\">key</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">expires_in</span>: <span class=\"pl-s1\">expires_in</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-s1\">put_policy</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">fsize_limit</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s1\">content_length</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">to_i</span> + <span class=\"pl-c1\">1000</span>\n      <span class=\"pl-s1\">put_policy</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">mime_limit</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s1\">content_type</span>\n      <span class=\"pl-s1\">put_policy</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">detect_mime</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">1</span>\n      <span class=\"pl-s1\">put_policy</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">insert_only</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">1</span>\n      <span class=\"pl-kos\">{</span>\n        <span class=\"pl-pds\">key</span>: <span class=\"pl-s1\">key</span><span class=\"pl-kos\">,</span>\n        <span class=\"pl-pds\">token</span>: <span class=\"pl-s1\">put_policy</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">to_token</span><span class=\"pl-kos\">,</span>\n        <span class=\"pl-s\">':file'</span>: <span class=\"pl-s\">'file'</span>\n      <span class=\"pl-kos\">}</span>\n    <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\">With above changes, <code class=\"notranslate\">ActiveStorage::Service</code> can support all types of HTTP methods, send token to cloud service with HTTP header or form data.</p>\n<p dir=\"auto\"><strong>change <code class=\"notranslate\">activestorage/app/models/active_storage/blob.rb</code> anonymous validator to named one:</strong></p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"  validate do\n    if service_name_changed? &amp;&amp; service_name.present?\n      services.fetch(service_name) do\n        errors.add(:service_name, :invalid)\n      end\n    end\n  end\"><pre class=\"notranslate\">  <span class=\"pl-en\">validate</span> <span class=\"pl-k\">do</span>\n    <span class=\"pl-k\">if</span> <span class=\"pl-en\">service_name_changed?</span> &amp;&amp; <span class=\"pl-en\">service_name</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">present?</span>\n      <span class=\"pl-en\">services</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">fetch</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">service_name</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n        <span class=\"pl-en\">errors</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">add</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">:service_name</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:invalid</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-k\">end</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\">changes to</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"validate :validate_service_name_in_services, if: -&gt; { service_name_changed? &amp;&amp; service_name.present? }\nprivate\n    def validate_service_name_in_services\n      services.fetch(service_name) do\n        errors.add(:service_name, :invalid)\n      end\n    end\"><pre class=\"notranslate\"><span class=\"pl-en\">validate</span> <span class=\"pl-pds\">:validate_service_name_in_services</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">if</span>: <span class=\"pl-c1\">-&gt;</span> <span class=\"pl-kos\">{</span> <span class=\"pl-en\">service_name_changed?</span> &amp;&amp; <span class=\"pl-en\">service_name</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">present?</span> <span class=\"pl-kos\">}</span>\n<span class=\"pl-k\">private</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">validate_service_name_in_services</span>\n      <span class=\"pl-en\">services</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">fetch</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">service_name</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n        <span class=\"pl-en\">errors</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">add</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">:service_name</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:invalid</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-k\">end</span>\n    <span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\">Now, we can write our own Module prepend to ActiveStorage::Blob, to override <code class=\"notranslate\">validate_service_name_in_services</code>, such as:</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"module ActiveStorageSaas::BlobModelMixin\n  private\n    def validate_service_name_in_services\n      # dynamically define service name per TenantStorageService#id, later we can resolve tenant storage\n      #   configuration by parsing TenantStorageService:1 to tenant_storage = TenantStorageService.find(1)\n      #   tenant_storage.service_name =&gt; Real Storage Service Name\n      #.  tenant_storage.service_options =&gt; options to make instance of Service\n      /^TenantStorageService:\\d+$/.match?(service_name) || super\n    end\nend\n\nActiveSupport.on_load(:active_storage_blob) do\n  prepend ActiveStorageSaas::BlobModelMixin\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">module</span> <span class=\"pl-v\">ActiveStorageSaas</span>::<span class=\"pl-v\">BlobModelMixin</span>\n  <span class=\"pl-k\">private</span>\n    <span class=\"pl-k\">def</span> <span class=\"pl-en\">validate_service_name_in_services</span>\n      <span class=\"pl-c\"># dynamically define service name per TenantStorageService#id, later we can resolve tenant storage</span>\n      <span class=\"pl-c\">#   configuration by parsing TenantStorageService:1 to tenant_storage = TenantStorageService.find(1)</span>\n      <span class=\"pl-c\">#   tenant_storage.service_name =&gt; Real Storage Service Name</span>\n      <span class=\"pl-c\">#.  tenant_storage.service_options =&gt; options to make instance of Service</span>\n      <span class=\"pl-pds\">/^TenantStorageService:<span class=\"pl-cce\">\\d</span>+$/</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">match?</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">service_name</span><span class=\"pl-kos\">)</span> || <span class=\"pl-smi\">super</span>\n    <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-v\">ActiveSupport</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">on_load</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">:active_storage_blob</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n  <span class=\"pl-en\">prepend</span> <span class=\"pl-v\">ActiveStorageSaas</span>::<span class=\"pl-v\">BlobModelMixin</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3 dir=\"auto\">Additional information</h3>\n\n<h3 dir=\"auto\">Checklist</h3>\n<ul dir=\"auto\">\n<li>This is another PR <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1282501642\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/45442\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/45442/hovercard\" href=\"https://github.com/rails/rails/pull/45442\">#45442</a> that has the same requirement to customize HTTP Method</li>\n<li>This is my real project that is working on this PR : <a href=\"https://github.com/xiaohui-zhangxh/activestorage_qinium/blob/main/lib/active_storage/service/qinium_service.rb\">https://github.com/xiaohui-zhangxh/activestorage_qinium/blob/main/lib/active_storage/service/qinium_service.rb</a></li>\n<li>This is my real project that need to make our Tenants have their own storage configurations : <a href=\"https://github.com/xiaohui-zhangxh/activestorage_saas/blob/main/lib/active_storage/service/saas_service.rb\">https://github.com/xiaohui-zhangxh/activestorage_saas/blob/main/lib/active_storage/service/saas_service.rb</a></li>\n<li>A duplicate PR <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1341323333\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/45839\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/45839/hovercard\" href=\"https://github.com/rails/rails/pull/45839\">#45839</a> to fix tests errors</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48189",
            "title": "Support more direct upload services by customize HTTP method and respose type",
            "date_modified": "2023-05-11T09:34:16.000Z",
            "date_published": "2023-05-11T09:34:11.000Z",
            "author": {
                "name": "xiaohui-zhangxh",
                "url": "https://github.com/xiaohui-zhangxh"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/19192189?u=dd60737844a9db7f1475bab21fc3e5258a405e15&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\"><span class=\"issue-keyword tooltipped tooltipped-se\" aria-label=\"This pull request closes issue #48173.\">Fix</span>: <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1701211131\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48173\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/48173/hovercard\" href=\"https://github.com/rails/rails/issues/48173\">#48173</a></p>\n<p dir=\"auto\">If for some reason the column identification fails, we should fallback to the old error rendering with only line information.</p>\n<p dir=\"auto\">cc <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/tenderlove/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/tenderlove\">@tenderlove</a></p>\n<p dir=\"auto\">FYI <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/jasonkim/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/jasonkim\">@jasonkim</a></p>",
            "url": "https://github.com/rails/rails/pull/48184",
            "title": "Properly fallback when ERB column can't be computed",
            "date_modified": "2023-05-11T06:56:11.000Z",
            "date_published": "2023-05-10T01:44:32.000Z",
            "author": {
                "name": "casperisfine",
                "url": "https://github.com/casperisfine"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/93165947?u=4aafc929ec1b2d5baf1afc9508c950960c371f71&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">I have added a new test case that raises an error if the credentials cannot be decrypted.</p>\n\n<h3 dir=\"auto\">Motivation / Background</h3>\n\n<p dir=\"auto\">This Pull Request has been created because [This test case aims to verify that an error is raised if the credentials cannot be decrypted. By adding this new test case, the codebase's testing coverage will be improved, which can help detect and fix potential issues and bugs.]</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes [Raises an error if the credentials cannot be decrypted.]</p>\n<h3 dir=\"auto\">Additional information</h3>\n\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48181",
            "title": "Raises an error if the credentials cannot be decrypted",
            "date_modified": "2023-05-10T14:36:37.000Z",
            "date_published": "2023-05-09T21:16:16.000Z",
            "author": {
                "name": "ajee10x",
                "url": "https://github.com/ajee10x"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/771968?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">This adds <code class=\"notranslate\">Object#isolated_copy</code> (as a private API) which performs a <code class=\"notranslate\">deep_dup</code> unless the object is frozen or a non-anonymous module.  In which case, it simply returns <code class=\"notranslate\">self</code>.</p>\n<p dir=\"auto\">TODO:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> tests</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> update <code class=\"notranslate\">thread_mattr_accessor</code> docs</li>\n</ul>\n<hr>\n<p dir=\"auto\"><a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/byroot/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/byroot\">@byroot</a> <code class=\"notranslate\">Module#deep_dup</code> returning <code class=\"notranslate\">self</code> may cause unexpected behavior (see <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1702310736\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48178\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/48178/hovercard\" href=\"https://github.com/rails/rails/pull/48178\">#48178</a>).  What do you think of replacing <code class=\"notranslate\">Module#deep_dup</code> with <code class=\"notranslate\">Module#isolated_copy</code>?  (In other words, restoring the original behavior of <code class=\"notranslate\">Module#deep_dup</code>, and defining <code class=\"notranslate\">Module#isolated_copy</code> with the specialized behavior instead.)</p>",
            "url": "https://github.com/rails/rails/pull/48179",
            "title": "Add `Object#isolated_copy`",
            "date_modified": "2023-05-10T18:03:32.000Z",
            "date_published": "2023-05-09T16:37:22.000Z",
            "author": {
                "name": "jonathanhefner",
                "url": "https://github.com/jonathanhefner"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/9117775?u=c5242a1b05e8272b9475a772e76fb3c5a7177445&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\"><span class=\"issue-keyword tooltipped tooltipped-se\" aria-label=\"This pull request closes issue #48164.\">Fixes</span> <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1699572304\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48164\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/48164/hovercard\" href=\"https://github.com/rails/rails/issues/48164\">#48164</a></p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">Introduces the concept of a transaction lock. This is used to detect cases where <code class=\"notranslate\">within_new_transaction</code> raises, potentially leaving the connection in an untracked, open transaction.</p>\n<p dir=\"auto\">The idea is to store and acquire a new lock before attempting to materialize a transaction, and to only discard the lock once the transaction state is definitely known. If <code class=\"notranslate\">within_new_transaction</code> raises, without the lock being discarded, subsequent attempts to create a transaction will detect this case and discard the connection.</p>\n<h3 dir=\"auto\">Additional information</h3>\n<ul dir=\"auto\">\n<li>The <code class=\"notranslate\">within_new_transaction</code> diff is mostly whitespace. Please consider reviewing with whitespace hidden: <a href=\"https://github.com/rails/rails/pull/48165/files?diff=unified&amp;w=1\">https://github.com/rails/rails/pull/48165/files?diff=unified&amp;w=1</a></li>\n<li>I have split <code class=\"notranslate\">begin_transaction</code> into <code class=\"notranslate\">create_transaction</code> and <code class=\"notranslate\">materialize_transaction_if_required</code> because creating a transaction cannot leave the connection in a bad state. If it raises, there is no need to discard the connection.</li>\n<li>I have introduced a new method to the TransactionManager API: <code class=\"notranslate\">check_transaction_state_known!</code>. If this change turns out to be acceptable, this method should be invoked before allowing access to the raw connection. For demonstration purposes, I have added a call to this method in <code class=\"notranslate\">execute</code> and <code class=\"notranslate\">transaction</code>.</li>\n</ul>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48165",
            "title": "Discard connection when in an unknown transaction state.",
            "date_modified": "2023-05-08T06:31:20.000Z",
            "date_published": "2023-05-08T06:14:14.000Z",
            "author": {
                "name": "nicholasdower",
                "url": "https://github.com/nicholasdower"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/2145?u=852c36277afc8bff6cfd2565a665294841184ecc&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">This Pull Request has been created because writing <code class=\"notranslate\">Rails.application.credentials</code> can be a tad cumbersome.</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes <code class=\"notranslate\">Rails</code> to have a convenient <code class=\"notranslate\">credentials</code> method for one less hop to get to credentials. (Similar to <code class=\"notranslate\">Rails.configuration</code>)</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48147",
            "title": "Add credentials convenience method on Rails",
            "date_modified": "2023-05-07T23:44:53.000Z",
            "date_published": "2023-05-06T04:07:39.000Z",
            "author": {
                "name": "mattpolito",
                "url": "https://github.com/mattpolito"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/5512772?u=bbae6d87b3499e6b3662664cf4be0e84cc40f6d2&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">This PR allows aliasing the <code class=\"notranslate\">id</code> column in cases where it is not<br>\nbeing used as a primary key.</p>\n<p dir=\"auto\">Currently there is no convenient way of reading the <code class=\"notranslate\">id</code> column value<br>\nwhich is not being used as a primary key as <code class=\"notranslate\">id</code> in Rails is a reserved<br>\nterm which means \"an identifier\" or the value stored in the primary key<br>\ncolumn.</p>\n<p dir=\"auto\">Given a <code class=\"notranslate\">posts</code> table with both <code class=\"notranslate\">id</code> and <code class=\"notranslate\">title</code> columns where <code class=\"notranslate\">title</code><br>\nis being used as a primary key it is possible to alias <code class=\"notranslate\">id</code> attribute<br>\nto a new name so we can fetch the column value.</p>\n<p dir=\"auto\">For example:</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"class Post &lt; ActiveRecord::Base\n  self.primary_key = :title\n  alias_attribute :post_id, :id\nend\n\npost = Post.create(title: &quot;Hello world&quot;)\npost.post_id # =&gt; 1\"><pre class=\"notranslate\"><span class=\"pl-k\">class</span> <span class=\"pl-v\">Post</span> &lt; <span class=\"pl-v\">ActiveRecord</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">primary_key</span> <span class=\"pl-c1\">=</span> <span class=\"pl-pds\">:title</span>\n  <span class=\"pl-en\">alias_attribute</span> <span class=\"pl-pds\">:post_id</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:id</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-s1\">post</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">create</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">title</span>: <span class=\"pl-s\">\"Hello world\"</span><span class=\"pl-kos\">)</span>\n<span class=\"pl-s1\">post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">post_id</span> <span class=\"pl-c\"># =&gt; 1</span></pre></div>\n<h3 dir=\"auto\">Technical details</h3>\n<p dir=\"auto\">Currently aliasing an attribute like <code class=\"notranslate\">alias_attribute :subject, :title</code> will define <code class=\"notranslate\">&lt;prefix_subject_suffix&gt;</code> methods that directly delegate to the <code class=\"notranslate\">*title*</code> methods. For example the <code class=\"notranslate\">subject</code> reader would look like:</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"def subject\n  title\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">def</span> <span class=\"pl-en\">subject</span>\n  <span class=\"pl-en\">title</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\">This works fine but doesn't work when aliasing the <code class=\"notranslate\">id</code> attribute as <code class=\"notranslate\">id</code> method is reserved to return the primary key value so in current implementation an alias like <code class=\"notranslate\">alias_attribute :subject, :id</code> ends up generating</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"def subject\n  id\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">def</span> <span class=\"pl-en\">subject</span>\n  <span class=\"pl-en\">id</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\">which will return the value behind the <code class=\"notranslate\">primary_key</code> column and not the <code class=\"notranslate\">id</code> column value.</p>\n<p dir=\"auto\">With the change we are proposing aliasing <code class=\"notranslate\">id</code> attribute will generate methods that call into so-called \"proxy\" methods that read directly from the attributes. So aliasing <code class=\"notranslate\">id</code> attribute will generate:</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"def subject\n  attribute(&quot;id&quot;)\nend\"><pre class=\"notranslate\"><span class=\"pl-k\">def</span> <span class=\"pl-en\">subject</span>\n  <span class=\"pl-en\">attribute</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"id\"</span><span class=\"pl-kos\">)</span>\n<span class=\"pl-k\">end</span></pre></div>\n<p dir=\"auto\"></p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/rails/rails/blob/d503e893056650524caaf9ffe0364417224c051a/activemodel/lib/active_model/attributes.rb#L148-L149\">rails/activemodel/lib/active_model/attributes.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 148 to 149\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/rails/rails/commit/d503e893056650524caaf9ffe0364417224c051a\">d503e89</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L148\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"148\"></td>\n          <td id=\"LC148\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">def</span> <span class=\"pl-en\">attribute</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">attr_name</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L149\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"149\"></td>\n          <td id=\"LC149\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-c1\">@attributes</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">fetch_value</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">attr_name</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\">along with <code class=\"notranslate\">attribute_was?</code> <code class=\"notranslate\">attribute_changed?</code>, etc and allow to access the <code class=\"notranslate\">id</code> value directly.</p>\n<p dir=\"auto\">We achieve this by abstracting the way how we build the method body in <code class=\"notranslate\">compilable_alias_attribute_method_body_for</code> and <code class=\"notranslate\">dynamic_alias_attribute_method_body_for</code> methods and override it from the <code class=\"notranslate\">PrimaryKey</code> module to build a different body for <code class=\"notranslate\">id</code> attribute.</p>\n<p dir=\"auto\">Since now we have versions of the alias attribute methods we had to make sure we are using two different namespaces to avoid one of the bodies being cached. This is to prevent issues when a non Active Record model, like an Active Model model aliases <code class=\"notranslate\">id</code> and pollutes the <code class=\"notranslate\">:alias_attribute</code> namespace cache with a non-primary key implementation.</p>\n<h3 dir=\"auto\">Long-term plans</h3>\n<p dir=\"auto\">What we initially planned and what we could do is to extend <code class=\"notranslate\">alias_attribute</code> to allow for aliasing of any of the Active Record reserved terms. For example if the application ends up in a situation where it needs to work with a schema that contains columns named with reserved terms it could alias these columns like:</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"alias_attribute :delete_value, :delete\nalias_attribute :save_value, :save\nalias_attribute :update_value, :update\n...\"><pre class=\"notranslate\"><span class=\"pl-en\">alias_attribute</span> <span class=\"pl-pds\">:delete_value</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:delete</span>\n<span class=\"pl-en\">alias_attribute</span> <span class=\"pl-pds\">:save_value</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:save</span>\n<span class=\"pl-en\">alias_attribute</span> <span class=\"pl-pds\">:update_value</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:update</span>\n...</pre></div>\n<p dir=\"auto\">However, we decided to limit it to <code class=\"notranslate\">id</code> only as at this moment it is not possible to boot a Rails app with a column name that conflicts with an Active Record reserved terms as it raises based on the <code class=\"notranslate\">dangerous_attribute_method?</code><br>\n</p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/rails/rails/blob/d503e893056650524caaf9ffe0364417224c051a/activerecord/lib/active_record/attribute_methods.rb#L87-L89\">rails/activerecord/lib/active_record/attribute_methods.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 87 to 89\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/rails/rails/commit/d503e893056650524caaf9ffe0364417224c051a\">d503e89</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L87\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"87\"></td>\n          <td id=\"LC87\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">def</span> <span class=\"pl-en\">instance_method_already_implemented?</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">method_name</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L88\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"88\"></td>\n          <td id=\"LC88\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-k\">if</span> <span class=\"pl-en\">dangerous_attribute_method?</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">method_name</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L89\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"89\"></td>\n          <td id=\"LC89\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-en\">raise</span> <span class=\"pl-v\">DangerousAttributeError</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-s1\">method_name</span><span class=\"pl-kos\">}</span></span> is defined by Active Record. Check to make sure that you don't have an attribute or method with the same name.\"</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\">So before extending the <code class=\"notranslate\">alias_attribute</code> capabilities we would need to change Rails to avoid raising the exception and allow application to boot with a conflicting column name so it can be aliased to a different attribute name. Which in our opinion deserves a separate PR.</p>\n<h3 dir=\"auto\">Side note</h3>\n<p dir=\"auto\">Overall it looks like the <code class=\"notranslate\">alias_attribute</code> generation could be simplified and we could at least get rid of one of the regexes<br>\n</p><div class=\"Box Box--condensed my-2\">\n  <div class=\"Box-header f6\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/rails/rails/blob/d503e893056650524caaf9ffe0364417224c051a/activemodel/lib/active_model/attribute_methods.rb#L67-L68\">rails/activemodel/lib/active_model/attribute_methods.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 67 to 68\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/rails/rails/commit/d503e893056650524caaf9ffe0364417224c051a\">d503e89</a>\n    </p>\n  </div>\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L67\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"67\"></td>\n          <td id=\"LC67\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-c1\">NAME_COMPILABLE_REGEXP</span> <span class=\"pl-c1\">=</span> <span class=\"pl-pds\">/<span class=\"pl-cce\">\\A</span>[a-zA-Z_]<span class=\"pl-cce\">\\w</span>*[!?=]?<span class=\"pl-cce\">\\z</span>/</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L68\" class=\"blob-num border-0 px-3 py-0 color-bg-default\" data-line-number=\"68\"></td>\n          <td id=\"LC68\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-c1\">CALL_COMPILABLE_REGEXP</span> <span class=\"pl-c1\">=</span> <span class=\"pl-pds\">/<span class=\"pl-cce\">\\A</span>[a-zA-Z_]<span class=\"pl-cce\">\\w</span>*[!?]?<span class=\"pl-cce\">\\z</span>/</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n<p></p>\n<p dir=\"auto\">Also <code class=\"notranslate\">COMPILABLE</code> term doesn't seem to be the best fit for the logic anymore. As far as I can tell it used to differentiate between methods built inline like a string (compiled) and methods that were defined using <code class=\"notranslate\">define_method</code><br>\nWe are not using <code class=\"notranslate\">define_method</code> anymore which means both of the branches are \"complied\" in the legacy terms.<br>\nSo it looks like we can refactor the logic to only do the <code class=\"notranslate\">.match</code> once to determine whether we want a <code class=\"notranslate\">send</code> body or <code class=\"notranslate\">self.method</code> body. It may not result in any performance gains but overall the logic is complex and it would be nice to simplify it a bit.</p>",
            "url": "https://github.com/rails/rails/pull/48144",
            "title": "Call proxy attribute methods for `id` alias attribute",
            "date_modified": "2023-05-11T15:25:49.000Z",
            "date_published": "2023-05-05T21:00:13.000Z",
            "author": {
                "name": "nvasilevski",
                "url": "https://github.com/nvasilevski"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/6014046?u=3972bfb97451f7f90e051df2e49fb7b8ee83e28d&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\"><span class=\"issue-keyword tooltipped tooltipped-se\" aria-label=\"This pull request closes issue #48135.\">Fixes</span> <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1697145934\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48135\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/48135/hovercard\" href=\"https://github.com/rails/rails/issues/48135\">#48135</a></p>\n<p dir=\"auto\">Encrypted keys were updated <a href=\"https://github.com/rails/rails/commit/4c6c3575c66ce10043c9ea04023788890a228de8\">previously</a> to restrict other users from reading the file by default. However, there is a brief period of time between an encrypted key being created and its permissions being set to 0600. This means that it is possible for another user to read that file during that time.</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This commit fixes that issue by setting the desired permissions when the file is created.</p>\n<h3 dir=\"auto\">Additional information</h3>\n<p dir=\"auto\">I've pointed this at my branch of Thor to show that <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1698030150\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/thor/issues/820\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/thor/pull/820/hovercard\" href=\"https://github.com/rails/thor/pull/820\">rails/thor#820</a> would enable fixing this, but that would have to be changed to merge this.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48141",
            "title": "Fix chmod race condition when generating key",
            "date_modified": "2023-05-11T09:29:27.000Z",
            "date_published": "2023-05-05T18:49:04.000Z",
            "author": {
                "name": "skipkayhil",
                "url": "https://github.com/skipkayhil"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/33079237?u=76f101f16829322713f7ba0c1496767a861ca89b&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">This is a problem that has existed since the introduction of <a href=\"https://github.com/rails/rails/pull/35077/files#r260410047\">ActiveRecord::InsertAll</a>.<br>\nInitially, <code class=\"notranslate\">ActiveRecord::InsertAll</code> used <code class=\"notranslate\">ActiveRecord::Relation::QueryAttribute#value_for_database</code> to convert values. As the code evolved, it switched to using <code class=\"notranslate\">ActiveModel::Type::XXX#serialize</code> to serialize values.<br>\nThis is inconsistent with how attributes are converted in <code class=\"notranslate\">Model#save</code>, which uses <code class=\"notranslate\">ActiveModel::Attribute::FromUser#value_for_database</code>.<br>\nTherefore, in some cases, data created using <code class=\"notranslate\">Model#insert</code> and <code class=\"notranslate\">Model#create</code> may be inconsistent. This PR fixes this issue.</p>\n<h3 dir=\"auto\">Detail</h3>\n<ul dir=\"auto\">\n<li>Fix value conversion of ActiveRecord::InsertAll::Builder#values_list</li>\n</ul>\n<h3 dir=\"auto\">Additional information</h3>\n\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>\n<p dir=\"auto\">cc <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/boblail/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/boblail\">@boblail</a> <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/tenderlove/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/tenderlove\">@tenderlove</a> <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/kamipo/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/kamipo\">@kamipo</a></p>\n<p dir=\"auto\"><em>PS: English is not my native language; please excuse typing errors.</em></p>",
            "url": "https://github.com/rails/rails/pull/48139",
            "title": "Fix active record insert values of type cast and serialize",
            "date_modified": "2023-05-11T10:55:50.000Z",
            "date_published": "2023-05-05T15:28:14.000Z",
            "author": {
                "name": "OuYangJinTing",
                "url": "https://github.com/OuYangJinTing"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/8878264?u=f2b36c3d2bb7d96ed8bb4009b02eba6f85bec0c1&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/>\n<h3 dir=\"auto\">Motivation / Background</h3>\n\n<p dir=\"auto\">We are working a lot with postgresql and schemas. I noticed that the ActiveRecord does not support many options for them. I want to enable possible options while maintaining similar behavior to <code class=\"notranslate\">create_table</code> and <code class=\"notranslate\">drop_table</code></p>\n<h3 dir=\"auto\">Detail</h3>\n<ul dir=\"auto\">\n<li>Added support of <strong>IF NOT EXISTS</strong> statement in <code class=\"notranslate\">create_schema</code></li>\n<li>Added support for <code class=\"notranslate\">force: cascade</code> option in <code class=\"notranslate\">create_schema</code></li>\n<li><strong>BREAKING CHANGE</strong> Changed default behavior of <code class=\"notranslate\">drop_schema</code>\n<ul dir=\"auto\">\n<li>no longer runs <strong>CASCADE</strong> by default</li>\n<li>supports <code class=\"notranslate\">force: :cascade</code> option, similar to <code class=\"notranslate\">drop_table</code></li>\n</ul>\n</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48132",
            "title": "Postgresql improvements to create_schema and drop_schema ",
            "date_modified": "2023-05-09T07:18:12.000Z",
            "date_published": "2023-05-04T19:55:09.000Z",
            "author": {
                "name": "Adam-Stomski",
                "url": "https://github.com/Adam-Stomski"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/3942920?u=b2d7cc12552ed41425f062fff196679a0d733d69&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">\"Fixes #<a href=\"https://github.com/rails/rails/issues/48077\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/48077/hovercard\">48077</a>\"</p>\n<p dir=\"auto\">copy of <a href=\"https://github.com/rails/rails/pull/48078\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/48078/hovercard\">PR</a> that was closed because of wrong rebase</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">When object is saved with <code class=\"notranslate\">belongs_to</code> association, that associated to object with <code class=\"notranslate\">has_one</code> relation, object actually saved   twice. For example:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"class Post &lt; ActiveRecord::Base\n  belongs_to :user\n  belongs_to :poll\n\n  after_commit :test_after_commit\n  # after_save :test_after_commit saved_changes here are exists\n  after_save :test_after_save\n\n  attr_reader :after_save_counter\n\n  def test_after_commit\n    # saved_changes here are blank\n    if saved_change_to_release_stage?(to: 'published')\n      user.increment(:published_posts_count)\n    end\n  end\n\n  def test_after_save\n    # invokes twice\n    @after_save_counter ||= 0\n    @after_save_counter += 1\n  end\nend\n\nclass Poll &lt; ActiveRecord::Base\n  has_one :post\nend\n\npost = Post.new(\n  user: user,\n  title: 'yoyo',\n  release_stage: 'published'\n)\n\npost.poll = Poll.new(multiple: true)\n\npost.save\"><pre class=\"notranslate\"><code class=\"notranslate\">class Post &lt; ActiveRecord::Base\n  belongs_to :user\n  belongs_to :poll\n\n  after_commit :test_after_commit\n  # after_save :test_after_commit saved_changes here are exists\n  after_save :test_after_save\n\n  attr_reader :after_save_counter\n\n  def test_after_commit\n    # saved_changes here are blank\n    if saved_change_to_release_stage?(to: 'published')\n      user.increment(:published_posts_count)\n    end\n  end\n\n  def test_after_save\n    # invokes twice\n    @after_save_counter ||= 0\n    @after_save_counter += 1\n  end\nend\n\nclass Poll &lt; ActiveRecord::Base\n  has_one :post\nend\n\npost = Post.new(\n  user: user,\n  title: 'yoyo',\n  release_stage: 'published'\n)\n\npost.poll = Poll.new(multiple: true)\n\npost.save\n</code></pre></div>\n<p dir=\"auto\">First poll object is saved, then AR try to save post from <code class=\"notranslate\">save_has_one_association</code>, after that invokes <code class=\"notranslate\">save</code> method second time and this second <code class=\"notranslate\">save</code> call clears saved_changes.</p>\n<p dir=\"auto\">I decided to add variable that show that object already saving and prevent second save from <code class=\"notranslate\">save_has_one_association</code> callback</p>",
            "url": "https://github.com/rails/rails/pull/48130",
            "title": "Fix belongs to with has one association multiple savings",
            "date_modified": "2023-05-04T17:43:58.000Z",
            "date_published": "2023-05-04T17:19:08.000Z",
            "author": {
                "name": "briu",
                "url": "https://github.com/briu"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/260602?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/>\n<h3 dir=\"auto\">Motivation / Background</h3>\n\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes the Postgres database adapter. It allows me to create models that are backed by a temporary table and use them just like regular tables. Without this change e.g. <code class=\"notranslate\">insert_all</code> and <code class=\"notranslate\">upsert_all</code> are not possible.</p>\n<h3 dir=\"auto\">Test</h3>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# frozen_string_literal: true\n\nrequire &quot;bundler/inline&quot;\n\ngemfile(true) do\n  source &quot;https://rubygems.org&quot;\n\n  git_source(:github) { |repo| &quot;https://github.com/#{repo}.git&quot; }\n\n  gem &quot;activerecord&quot;, path: './activerecord'\n  gem &quot;pg&quot;\nend\n\nrequire &quot;active_record&quot;\nrequire &quot;minitest/autorun&quot;\nrequire &quot;logger&quot;\n\nActiveRecord::Base.establish_connection(adapter: &quot;postgresql&quot;, url: &quot;postgres://localhost/rails-issue&quot;) rescue puts 'Please create a DB &quot;rails-issue&quot; yourself first'\nActiveRecord::Base.logger = Logger.new(STDOUT)\n\nclass Post &lt; ActiveRecord::Base\n  def self.with_temp_table(as:)\n    transaction do\n      connection.create_table(table_name, temporary: true, force: true, as: as)\n      yield\n    end\n  end\nend\n\nclass BugTest &lt; Minitest::Test\n  def test_upsert_in_temp_table\n\n    # Create a model backed by a temp table. Prefill the table with some data from a query.\n    Post.with_temp_table(as: &quot;select 1 as id, 'foo' as some_column&quot;) do\n      # Upserts require a unique constraint\n      Post.connection.add_index(Post.table_name, :id, unique: true)\n\n      assert_equal Post.new(id: 1, some_column: 'foo'), Post.sole\n\n      # The following line fails on master with:\n      #\n      #   ActiveRecord::StatementInvalid: PG::SyntaxError: ERROR:  syntax error at or near &quot;)&quot;\n      #   LINE 1: ...id&quot;,&quot;some_column&quot;) VALUES (1, 'bar') ON CONFLICT () DO UPDAT...\n      #\n      # The temp table, including all indices, constraints, etc are not 'seen'\n      # by Rails. The PostgreSQL adapter only considers stuff in the schemas\n      # returned by current_schemas(false). The temporary namespace\n      # 'pg_temp_xyz' is excluded.\n      #\n      # See https://www.postgresql.org/docs/15/functions-info.html\n      #\n      #   current_schemas ( include_implicit boolean ) → name[]\n      #\n      #   Returns an array of the names of all schemas presently in the\n      #   effective search path, in their priority order. (Items in the current\n      #   search_path setting that do not correspond to existing, searchable\n      #   schemas are omitted.) If the Boolean argument is true, then\n      #   implicitly-searched system schemas such as pg_catalog are included in\n      #   the result.\n      #\n      # If you include implicit tables, via current_schemas(true), the\n      # temporary table is found, but that is also true for the other system\n      # schemas that we don't want.\n      #\n      # Luckily Postgres provides a means to find the temp schema name via:\n      #\n      #   pg_my_temp_schema () → oid\n      #\n      #   Returns the OID of the current session's temporary schema, or zero if\n      #   it has none (because it has not created any temporary tables).\n      #\n      # If we add that to the search path, then temp tables work just like\n      # regular tables.\n      Post.upsert_all([{ id: 1, some_column: 'bar' }], unique_by: :id)\n\n      assert_equal Post.new(id: 1, some_column: 'bar'), Post.sole\n    end\n  end\nend\"><pre class=\"notranslate\"><span class=\"pl-c\"># frozen_string_literal: true</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"bundler/inline\"</span>\n\n<span class=\"pl-en\">gemfile</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">true</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n  <span class=\"pl-en\">source</span> <span class=\"pl-s\">\"https://rubygems.org\"</span>\n\n  <span class=\"pl-en\">git_source</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">:github</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> |<span class=\"pl-s1\">repo</span>| <span class=\"pl-s\">\"https://github.com/<span class=\"pl-s1\"><span class=\"pl-kos\">#{</span><span class=\"pl-s1\">repo</span><span class=\"pl-kos\">}</span></span>.git\"</span> <span class=\"pl-kos\">}</span>\n\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">\"activerecord\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">path</span>: <span class=\"pl-s\">'./activerecord'</span>\n  <span class=\"pl-en\">gem</span> <span class=\"pl-s\">\"pg\"</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"active_record\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"minitest/autorun\"</span>\n<span class=\"pl-en\">require</span> <span class=\"pl-s\">\"logger\"</span>\n\n<span class=\"pl-v\">ActiveRecord</span>::<span class=\"pl-v\">Base</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">establish_connection</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">adapter</span>: <span class=\"pl-s\">\"postgresql\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">url</span>: <span class=\"pl-s\">\"postgres://localhost/rails-issue\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">rescue</span> <span class=\"pl-en\">puts</span> <span class=\"pl-s\">'Please create a DB \"rails-issue\" yourself first'</span>\n<span class=\"pl-v\">ActiveRecord</span>::<span class=\"pl-v\">Base</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">logger</span> <span class=\"pl-c1\">=</span> <span class=\"pl-v\">Logger</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-c1\">STDOUT</span><span class=\"pl-kos\">)</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">Post</span> &lt; <span class=\"pl-v\">ActiveRecord</span>::<span class=\"pl-v\">Base</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-smi\">self</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">with_temp_table</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">as</span>:<span class=\"pl-kos\">)</span>\n    <span class=\"pl-en\">transaction</span> <span class=\"pl-k\">do</span>\n      <span class=\"pl-en\">connection</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">create_table</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">table_name</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">temporary</span>: <span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">force</span>: <span class=\"pl-c1\">true</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">as</span>: <span class=\"pl-s1\">as</span><span class=\"pl-kos\">)</span>\n      <span class=\"pl-k\">yield</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span>\n\n<span class=\"pl-k\">class</span> <span class=\"pl-v\">BugTest</span> &lt; <span class=\"pl-v\">Minitest</span>::<span class=\"pl-v\">Test</span>\n  <span class=\"pl-k\">def</span> <span class=\"pl-en\">test_upsert_in_temp_table</span>\n\n    <span class=\"pl-c\"># Create a model backed by a temp table. Prefill the table with some data from a query.</span>\n    <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">with_temp_table</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">as</span>: <span class=\"pl-s\">\"select 1 as id, 'foo' as some_column\"</span><span class=\"pl-kos\">)</span> <span class=\"pl-k\">do</span>\n      <span class=\"pl-c\"># Upserts require a unique constraint</span>\n      <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">connection</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">add_index</span><span class=\"pl-kos\">(</span><span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">table_name</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">:id</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">unique</span>: <span class=\"pl-c1\">true</span><span class=\"pl-kos\">)</span>\n\n      <span class=\"pl-en\">assert_equal</span> <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">id</span>: <span class=\"pl-c1\">1</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">some_column</span>: <span class=\"pl-s\">'foo'</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">sole</span>\n\n      <span class=\"pl-c\"># The following line fails on master with:</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\">#   ActiveRecord::StatementInvalid: PG::SyntaxError: ERROR:  syntax error at or near \")\"</span>\n      <span class=\"pl-c\">#   LINE 1: ...id\",\"some_column\") VALUES (1, 'bar') ON CONFLICT () DO UPDAT...</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\"># The temp table, including all indices, constraints, etc are not 'seen'</span>\n      <span class=\"pl-c\"># by Rails. The PostgreSQL adapter only considers stuff in the schemas</span>\n      <span class=\"pl-c\"># returned by current_schemas(false). The temporary namespace</span>\n      <span class=\"pl-c\"># 'pg_temp_xyz' is excluded.</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\"># See https://www.postgresql.org/docs/15/functions-info.html</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\">#   current_schemas ( include_implicit boolean ) → name[]</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\">#   Returns an array of the names of all schemas presently in the</span>\n      <span class=\"pl-c\">#   effective search path, in their priority order. (Items in the current</span>\n      <span class=\"pl-c\">#   search_path setting that do not correspond to existing, searchable</span>\n      <span class=\"pl-c\">#   schemas are omitted.) If the Boolean argument is true, then</span>\n      <span class=\"pl-c\">#   implicitly-searched system schemas such as pg_catalog are included in</span>\n      <span class=\"pl-c\">#   the result.</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\"># If you include implicit tables, via current_schemas(true), the</span>\n      <span class=\"pl-c\"># temporary table is found, but that is also true for the other system</span>\n      <span class=\"pl-c\"># schemas that we don't want.</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\"># Luckily Postgres provides a means to find the temp schema name via:</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\">#   pg_my_temp_schema () → oid</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\">#   Returns the OID of the current session's temporary schema, or zero if</span>\n      <span class=\"pl-c\">#   it has none (because it has not created any temporary tables).</span>\n      <span class=\"pl-c\">#</span>\n      <span class=\"pl-c\"># If we add that to the search path, then temp tables work just like</span>\n      <span class=\"pl-c\"># regular tables.</span>\n      <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">upsert_all</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">[</span><span class=\"pl-kos\">{</span> <span class=\"pl-pds\">id</span>: <span class=\"pl-c1\">1</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">some_column</span>: <span class=\"pl-s\">'bar'</span> <span class=\"pl-kos\">}</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">unique_by</span>: <span class=\"pl-pds\">:id</span><span class=\"pl-kos\">)</span>\n\n      <span class=\"pl-en\">assert_equal</span> <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">new</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">id</span>: <span class=\"pl-c1\">1</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">some_column</span>: <span class=\"pl-s\">'bar'</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-v\">Post</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">sole</span>\n    <span class=\"pl-k\">end</span>\n  <span class=\"pl-k\">end</span>\n<span class=\"pl-k\">end</span></pre></div>\n<h3 dir=\"auto\">Additional information</h3>\n\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48117",
            "title": "Support upsert in Postgres temp tables",
            "date_modified": "2023-05-08T17:58:14.000Z",
            "date_published": "2023-05-03T09:19:29.000Z",
            "author": {
                "name": "rschellhorn",
                "url": "https://github.com/rschellhorn"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/163168?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/>\n<h3 dir=\"auto\">Motivation / Background</h3>\n\n<p dir=\"auto\">When using the <code class=\"notranslate\">expires_in</code> option to generate an expiration URL, the URL will change each time.<br>\nBy using the <code class=\"notranslate\">expires_at</code> option as shown in the example below, the browser cache can be used for a certain period of time.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"rails_blob_path(user.avatar, disposition: &quot;attachment&quot;, expires_at: 2.hours.from_now.beginning_of_hour)\n&lt;%= image_tag rails_blob_path(user.avatar.variant(resize: &quot;100x100&quot;), expires_at: 2.hours.from_now.beginning_of_hour) %&gt;\"><pre class=\"notranslate\"><span class=\"pl-en\">rails_blob_path</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">user</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">avatar</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">disposition</span>: <span class=\"pl-s\">\"attachment\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">expires_at</span>: <span class=\"pl-c1\">2</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">hours</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">from_now</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">beginning_of_hour</span><span class=\"pl-kos\">)</span>\n&lt;%= <span class=\"pl-en\">image_tag</span> <span class=\"pl-en\">rails_blob_path</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">user</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">avatar</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">variant</span><span class=\"pl-kos\">(</span><span class=\"pl-pds\">resize</span>: <span class=\"pl-s\">\"100x100\"</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">expires_at</span>: <span class=\"pl-c1\">2</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">hours</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">from_now</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">beginning_of_hour</span><span class=\"pl-kos\">)</span> %&gt;</pre></div>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">Add <code class=\"notranslate\">expires_at</code> option to <code class=\"notranslate\">ActiveStorage::Blob#signed_id</code> and URL helpers.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48115",
            "title": "Add `expires_at` option to `ActiveStorage::Blob#signed_id`",
            "date_modified": "2023-05-02T22:40:06.000Z",
            "date_published": "2023-05-02T22:20:21.000Z",
            "author": {
                "name": "aki77",
                "url": "https://github.com/aki77"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/13070410?u=552efa2d0943af80a64d99ecd7489fce46a9475b&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/>\n<h3 dir=\"auto\">Motivation / Background</h3>\n\n<p dir=\"auto\">This Pull Request has been created because Rails doesn't provide by default a way to validate if a number is within the database limit. That's problematic when one is trying to store an ID to another table without foreign key since one would need to manually add the logic for this validation, possibly using <code class=\"notranslate\">validates_numericality_of</code> range.</p>\n<div class=\"highlight highlight-source-ruby notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"MAX_EIGHT_BYTES_SIGNED_NUMBER = 2**63 - 1\nprivate_constant :MAX_EIGHT_BYTES_SIGNED_NUMBER\n\n# It should store a valid database record; thus, it should not be negative and it can go up to the maximum value\n# supported by the column, which is using the default bigint type size of 8 bytes.\nVALID_ID_RANGE = (..MAX_EIGHT_BYTES_SIGNED_NUMBER)\nprivate_constant :VALID_ID_RANGE\n\nvalidates :model_id, numericality: { in: VALID_ID_RANGE }\"><pre class=\"notranslate\"><span class=\"pl-c1\">MAX_EIGHT_BYTES_SIGNED_NUMBER</span> <span class=\"pl-c1\">=</span> <span class=\"pl-c1\">2</span>**<span class=\"pl-c1\">63</span> - <span class=\"pl-c1\">1</span>\n<span class=\"pl-en\">private_constant</span> <span class=\"pl-pds\">:MAX_EIGHT_BYTES_SIGNED_NUMBER</span>\n\n<span class=\"pl-c\"># It should store a valid database record; thus, it should not be negative and it can go up to the maximum value</span>\n<span class=\"pl-c\"># supported by the column, which is using the default bigint type size of 8 bytes.</span>\n<span class=\"pl-c1\">VALID_ID_RANGE</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">(</span>..<span class=\"pl-c1\">MAX_EIGHT_BYTES_SIGNED_NUMBER</span><span class=\"pl-kos\">)</span>\n<span class=\"pl-en\">private_constant</span> <span class=\"pl-pds\">:VALID_ID_RANGE</span>\n\n<span class=\"pl-en\">validates</span> <span class=\"pl-pds\">:model_id</span><span class=\"pl-kos\">,</span> <span class=\"pl-pds\">numericality</span>: <span class=\"pl-kos\">{</span> <span class=\"pl-pds\">in</span>: <span class=\"pl-c1\">VALID_ID_RANGE</span> <span class=\"pl-kos\">}</span></pre></div>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This Pull Request changes <code class=\"notranslate\">ActiveRecord::Validations::NumericalityValidator</code> to support a new value for the <code class=\"notranslate\">in:</code> option: <code class=\"notranslate\">:limit</code>.</p>\n<p dir=\"auto\"><code class=\"notranslate\">:limit</code> will verify the column's SQL type metadata limit to create a range with it. If the value is a <code class=\"notranslate\">virtual attribute</code>, an exception is raised. If the column doesn't have a <code class=\"notranslate\">limit</code> value set, the validation will be ignored.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48114",
            "title": "Add `:limit` to `validates_numericality_of`",
            "date_modified": "2023-05-02T21:49:13.000Z",
            "date_published": "2023-05-02T19:09:43.000Z",
            "author": {
                "name": "edaroit",
                "url": "https://github.com/edaroit"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/19192189?u=dd60737844a9db7f1475bab21fc3e5258a405e15&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">Their value seem very limited, and I fear they cause users to rescue these specifc errors rather than the general <code class=\"notranslate\">ConnectionFailed</code> one.</p>\n<p dir=\"auto\">FYI <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/adrianna-chang-shopify/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/adrianna-chang-shopify\">@adrianna-chang-shopify</a> <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/matthewd/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/matthewd\">@matthewd</a> <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/jhawthorn/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/jhawthorn\">@jhawthorn</a></p>",
            "url": "https://github.com/rails/rails/pull/48109",
            "title": "Get rid of TrilogyAdapter's special errors",
            "date_modified": "2023-05-03T07:28:52.000Z",
            "date_published": "2023-05-02T14:07:10.000Z",
            "author": {
                "name": "casperisfine",
                "url": "https://github.com/casperisfine"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/1100970?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">We have monkey patched ActiveRecord internally to perform query retry and connection retry to recover from failures automatically with Postgres. Part of that functionality is to retry the select statements. The support for <code class=\"notranslate\">allow_retry</code> today doesn't not retry select statements in Postgres.</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This PR proposes that we retry prepared select statements for Postgres automatically by passing in <code class=\"notranslate\">allow_retry: true</code> to <code class=\"notranslate\">internal_exec_query</code> on <code class=\"notranslate\">select</code> method inside <code class=\"notranslate\">ActiveRecord::ConnectionAdapters::DatabaseStatements</code>.  Doing so allows Rails to automatically retry the select queries on connection disruption to Postgres database, in an even of a failover, crash or similar. Since it uses the existing work done on <code class=\"notranslate\">allow_retry</code> the behavior should be consistent with what is supplied via <code class=\"notranslate\">connection_retries</code>. Lastly,  <code class=\"notranslate\">internal_exec_query</code> only accepts <code class=\"notranslate\">allow_retry</code> as a method argument for the Postgres adapter currently.</p>\n<p dir=\"auto\">This PR also ensures that we re-build the prepared statement in an even of a retry since the statement pool cache will be cleared when a <strong><a href=\"https://github.com/rails/rails/blob/912096d4ce930b8e7e5d91e0c86bae2091fda0e4/activerecord/lib/active_record/connection_adapters/abstract_adapter.rb#L1030\"><code class=\"notranslate\">reconnect!</code></a></strong> is called</p>\n<h3 dir=\"auto\">Additional information</h3>\n<p dir=\"auto\">Note: This PR builds on top of - <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1688825204\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48093\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/48093/hovercard\" href=\"https://github.com/rails/rails/pull/48093\">#48093</a>. However, its not possible to have a child branch from a fork in Github (AFAICT), so its expected the specs will fail until a fix similar to the one in the PR is available. Once/if that PR merges, we can rebase and accordingly the new specs should pass.</p>\n<p dir=\"auto\">Also, intentionally only making it work for Postgres. Happy to take a pass on MySQL and other adapters if it makes sense in separate PRs.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> Rebase from <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1688825204\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48093\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/rails/rails/pull/48093/hovercard\" href=\"https://github.com/rails/rails/pull/48093\">#48093</a></li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48102",
            "title": "Retry select prepared statements in postgres",
            "date_modified": "2023-05-01T14:57:43.000Z",
            "date_published": "2023-05-01T14:42:28.000Z",
            "author": {
                "name": "shayonj",
                "url": "https://github.com/shayonj"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/4342912?u=757d994c6a31ca40aef3785d9e03c19844d42524&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\">We wanted to use the HTML <code class=\"notranslate\">&lt;picture&gt;</code> tag in our website for responsive images (specifically, for art direction) and found that Rails did not have built-in support for it. By introducing the <code class=\"notranslate\">picture_tag</code> helper, we can simplify the usage of the <code class=\"notranslate\">&lt;picture&gt;</code> element in Rails applications, enabling developers to incorporate responsive images in their projects easily.</p>\n<p dir=\"auto\">The need for a <code class=\"notranslate\">picture_tag</code> in Rails led to the creation of <a href=\"https://github.com/eagerworks/next_gen_images\">this gem</a> and this <a href=\"https://railsconf2023.sessionize.com/session/452773\" rel=\"nofollow\">RailsConf talk</a>. After presenting the talk, a lot of people told me I should add this feature to Rails, so I'm porting some of the gem's functionality here.</p>\n<p dir=\"auto\">The <code class=\"notranslate\">picture</code> tag is a more \"robust\" version of the <code class=\"notranslate\">img</code> tag, because it supports resolution switching, art direction, and image support fallback, so I think we should have it in Rails (the <code class=\"notranslate\">img</code> tag only supports resolution switching). More information here:</p>\n<ul dir=\"auto\">\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/picture\" rel=\"nofollow\">Picture tag</a></li>\n<li><a href=\"https://webdesign.tutsplus.com/tutorials/quick-tip-how-to-use-html5-picture-for-responsive-images--cms-21015\" rel=\"nofollow\">Responsive images &amp; picture element</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Responsive_images\" rel=\"nofollow\">Responsive images &amp; Art direction</a></li>\n</ul>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">This PR adds support for the HTML picture tag. It supports passing one element (String), multiple (an Array), or a Block if you need full control of what it's being generated. All properties that are passed to the helper will apply to the <code class=\"notranslate\">picture</code> tag. If you need to pass properties to the <code class=\"notranslate\">img</code> tag, you can do it inside the <code class=\"notranslate\">:image</code> key.</p>\n<p dir=\"auto\">Since the <code class=\"notranslate\">picture</code> tag requires an <code class=\"notranslate\">img</code> tag (contrary to the <code class=\"notranslate\">audio_tag</code> or <code class=\"notranslate\">video_tag</code>, which only require <code class=\"notranslate\">source</code>s), the last element you provide will be used as the source for the <code class=\"notranslate\">img</code> tag. For complete control over the picture tag, a block can be passed, which will populate the contents of the tag accordingly.</p>\n<p dir=\"auto\">It can be used like this for a single source:</p>\n<div class=\"highlight highlight-text-html-erb notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"&lt;%= picture_tag(&quot;picture.webp&quot;) %&gt;\"><pre class=\"notranslate\"><span class=\"pl-k\">&lt;%=</span> picture_tag(\"picture.webp\") <span class=\"pl-k\">%&gt;</span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span></pre></div>\n<p dir=\"auto\">which will generate the following:</p>\n<div class=\"highlight highlight-text-html-basic notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"&lt;picture&gt;\n    &lt;img src=&quot;/images/picture.webp&quot; /&gt;\n&lt;/picture&gt;\"><pre class=\"notranslate\"><span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">picture</span><span class=\"pl-kos\">&gt;</span>\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">img</span> <span class=\"pl-c1\">src</span>=\"<span class=\"pl-s\">/images/picture.webp</span>\" /&gt;\n<span class=\"pl-kos\">&lt;/</span><span class=\"pl-ent\">picture</span><span class=\"pl-kos\">&gt;</span></pre></div>\n<p dir=\"auto\">For multiple sources:</p>\n<div class=\"highlight highlight-text-html-erb notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"&lt;%= picture_tag(&quot;picture.webp&quot;, &quot;picture.png&quot;, :class =&gt; &quot;mt-2&quot;,  :image =&gt; { alt: &quot;Image&quot;, class: &quot;responsive-img&quot; }) %&gt;\"><pre class=\"notranslate\"><span class=\"pl-k\">&lt;%=</span> picture_tag(\"picture.webp\", \"picture.png\", :class =&gt; \"mt-2\",  :image =&gt; { alt: \"Image\", class: \"responsive-img\" }) <span class=\"pl-k\">%&gt;</span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-c1\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-c1\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-kos\"></span></pre></div>\n<p dir=\"auto\">will generate:</p>\n<div class=\"highlight highlight-text-html-basic notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"&lt;picture class=&quot;mt-2&quot;&gt;\n    &lt;source srcset=&quot;/images/picture.webp&quot; /&gt;\n    &lt;source srcset=&quot;/images/picture.png&quot; /&gt;\n    &lt;img alt=&quot;Image&quot; class=&quot;responsive-img&quot; src=&quot;/images/picture.png&quot; /&gt;\n&lt;/picture&gt;\"><pre class=\"notranslate\"><span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">picture</span> <span class=\"pl-c1\">class</span>=\"<span class=\"pl-s\">mt-2</span>\"<span class=\"pl-kos\">&gt;</span>\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">source</span> <span class=\"pl-c1\">srcset</span>=\"<span class=\"pl-s\">/images/picture.webp</span>\" /&gt;\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">source</span> <span class=\"pl-c1\">srcset</span>=\"<span class=\"pl-s\">/images/picture.png</span>\" /&gt;\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">img</span> <span class=\"pl-c1\">alt</span>=\"<span class=\"pl-s\">Image</span>\" <span class=\"pl-c1\">class</span>=\"<span class=\"pl-s\">responsive-img</span>\" <span class=\"pl-c1\">src</span>=\"<span class=\"pl-s\">/images/picture.png</span>\" /&gt;\n<span class=\"pl-kos\">&lt;/</span><span class=\"pl-ent\">picture</span><span class=\"pl-kos\">&gt;</span></pre></div>\n<p dir=\"auto\">Full control via a block:</p>\n<div class=\"highlight highlight-text-html-erb notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"&lt;%= picture_tag(:class =&gt; &quot;my-class&quot;) do %&gt;\n    &lt;%= tag(:source, :srcset =&gt; image_path(&quot;picture.webp&quot;)) %&gt;\n    &lt;%= tag(:source, :srcset =&gt; image_path(&quot;picture.png&quot;)) %&gt;\n    &lt;%= image_tag(&quot;picture.png&quot;, :alt =&gt; &quot;Image&quot;) %&gt;\n&lt;% end %&gt;\"><pre class=\"notranslate\"><span class=\"pl-k\">&lt;%=</span> picture_tag(:class =&gt; \"my-class\") do <span class=\"pl-k\">%&gt;</span><span class=\"pl-k\"></span>\n<span class=\"pl-k\">    &lt;%=</span> tag(:source, :srcset =&gt; image_path(\"picture.webp\")) <span class=\"pl-k\">%&gt;</span><span class=\"pl-k\"></span>\n<span class=\"pl-k\">    &lt;%=</span> tag(:source, :srcset =&gt; image_path(\"picture.png\")) <span class=\"pl-k\">%&gt;</span><span class=\"pl-k\"></span>\n<span class=\"pl-k\">    &lt;%=</span> image_tag(\"picture.png\", :alt =&gt; \"Image\") <span class=\"pl-k\">%&gt;</span><span class=\"pl-k\"></span>\n<span class=\"pl-k\">&lt;%</span> end <span class=\"pl-k\">%&gt;</span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-c1\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-k\"></span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-c1\"></span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-kos\"></span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-c1\"></span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-kos\"></span><span class=\"pl-en\"></span><span class=\"pl-kos\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-pds\"></span><span class=\"pl-c1\"></span><span class=\"pl-s\"></span><span class=\"pl-kos\"></span><span class=\"pl-k\"></span></pre></div>\n<p dir=\"auto\">will generate:</p>\n<div class=\"highlight highlight-text-html-basic notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"&lt;picture class=&quot;my-class&quot;&gt;\n    &lt;source srcset=&quot;/images/picture.webp&quot; /&gt;\n    &lt;source srcset=&quot;/images/picture.png&quot; /&gt;\n    &lt;img alt=&quot;Image&quot; src=&quot;/images/picture.png&quot; /&gt;\n&lt;/picture&gt;\"><pre class=\"notranslate\"><span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">picture</span> <span class=\"pl-c1\">class</span>=\"<span class=\"pl-s\">my-class</span>\"<span class=\"pl-kos\">&gt;</span>\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">source</span> <span class=\"pl-c1\">srcset</span>=\"<span class=\"pl-s\">/images/picture.webp</span>\" /&gt;\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">source</span> <span class=\"pl-c1\">srcset</span>=\"<span class=\"pl-s\">/images/picture.png</span>\" /&gt;\n    <span class=\"pl-kos\">&lt;</span><span class=\"pl-ent\">img</span> <span class=\"pl-c1\">alt</span>=\"<span class=\"pl-s\">Image</span>\" <span class=\"pl-c1\">src</span>=\"<span class=\"pl-s\">/images/picture.png</span>\" /&gt;\n<span class=\"pl-kos\">&lt;/</span><span class=\"pl-ent\">picture</span><span class=\"pl-kos\">&gt;</span></pre></div>\n<h3 dir=\"auto\">Additional information</h3>\n<p dir=\"auto\">Another option would be to be more explicit on the image and sources that are generated (could be more cumbersome).<br>\nSomething like this:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"picture_tag(&quot;image.jpg&quot;, sources: [{ srcset: &quot;image_small.jpg&quot;, media: &quot;(min-width: 400px)&quot; }, { srcset: &quot;image_big.jpg&quot; }], alt: &quot;An example image&quot;, class: &quot;responsive-image&quot;)\"><pre class=\"notranslate\"><code class=\"notranslate\">picture_tag(\"image.jpg\", sources: [{ srcset: \"image_small.jpg\", media: \"(min-width: 400px)\" }, { srcset: \"image_big.jpg\" }], alt: \"An example image\", class: \"responsive-image\")\n</code></pre></div>\n<p dir=\"auto\">The issue with this is that we would need a way to specify which properties belong to the <code class=\"notranslate\">img</code> tag and which to the <code class=\"notranslate\">picture</code> tag itself. I did not go with this approach since I tried to more or less replicate how the <code class=\"notranslate\">audio_tag</code>, <code class=\"notranslate\">video_tag</code>, and <code class=\"notranslate\">image_tag</code> helpers work.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48100",
            "title": "Add a picture_tag helper",
            "date_modified": "2023-05-09T12:15:44.000Z",
            "date_published": "2023-04-30T17:42:50.000Z",
            "author": {
                "name": "jpbalarini",
                "url": "https://github.com/jpbalarini"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/16636757?u=27830160a8177896eb66623c0a9b730015a2aae0&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><p dir=\"auto\">Currently, we don't document the use case for ActiveJob's <code class=\"notranslate\">queue_with_priority</code> block arguments. It seems necessary to document them in the API docs as well considering how useful this option is.</p>",
            "url": "https://github.com/rails/rails/pull/48099",
            "title": "Document queue_with_priority block arguments and their use [ci skip]",
            "date_modified": "2023-05-08T13:14:39.000Z",
            "date_published": "2023-04-30T06:51:33.000Z",
            "author": {
                "name": "shivamsinghchahar",
                "url": "https://github.com/shivamsinghchahar"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/19731661?u=c357f2a01218b4864aba60738484286b95d97ecc&v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background</h3>\n<p dir=\"auto\"><span class=\"issue-keyword tooltipped tooltipped-se\" aria-label=\"This pull request closes issue #48094.\">Fixes</span> <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"1689435061\" data-permission-text=\"Title is private\" data-url=\"https://github.com/rails/rails/issues/48094\" data-hovercard-type=\"issue\" data-hovercard-url=\"/rails/rails/issues/48094/hovercard\" href=\"https://github.com/rails/rails/issues/48094\">#48094</a><br>\n<code class=\"notranslate\">unscope</code> not working when where by tripe dot range</p>\n<h3 dir=\"auto\">Detail</h3>\n<p dir=\"auto\">Define <code class=\"notranslate\">fetch_attribute</code> to <code class=\"notranslate\">activerecord/lib/arel/nodes/and.rb</code>, because unscope uses fetch_attribute to determine whether to exclude predicate or not.</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\"> <del>CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</del></li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48095",
            "title": "Fix unscope not working when where by tripe dot range",
            "date_modified": "2023-04-29T07:48:44.000Z",
            "date_published": "2023-04-29T07:48:40.000Z",
            "author": {
                "name": "ippachi",
                "url": "https://github.com/ippachi"
            }
        },
        {
            "content_html": "<img src=\"https://avatars.githubusercontent.com/u/1100970?v=4\" width=\"64\" height=\"64\" alt=\"\"/><br/><h3 dir=\"auto\">Motivation / Background &amp; Details</h3>\n<p dir=\"auto\"><g-emoji class=\"g-emoji\" alias=\"wave\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f44b.png\">👋</g-emoji> Hi team! Fresh off RailsConf here. Enjoyed some of the convos with matthewd and figured I'd check out the new connection and query retry feature on rails@main. We have monkey patched ActiveRecord internally to perform query retry and connection retry to recover from failures automatically with Postgres.</p>\n<p dir=\"auto\">While testing, I came across the following issue:</p>\n<p dir=\"auto\">Postgres can at times throw the following error.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"server closed the connection unexpectedly\n        This probably means the server terminated abnormally\n        before or while processing the request.\"><pre class=\"notranslate\"><code class=\"notranslate\">server closed the connection unexpectedly\n        This probably means the server terminated abnormally\n        before or while processing the request.\n</code></pre></div>\n<p dir=\"auto\">This can happen during a database crash or a failover, or when connections are intentionally terminated. When this happens, an already checked out ActiveRecord connection would raise <code class=\"notranslate\">ActiveRecord::StatementInvalid: PG::UnableToSend: server closed the connection unexpectedly</code>.</p>\n<p dir=\"auto\">Raising an <code class=\"notranslate\">ActiveRecord::StatementInvalid</code> means that the query will not get retried, even when <code class=\"notranslate\">allow_retry</code> is set to <code class=\"notranslate\">true</code> because only <code class=\"notranslate\">ConnectionNotEstablished</code> or <code class=\"notranslate\">ConnectionFailed</code> are considered for retries (via <code class=\"notranslate\">retryable_connection_error?</code>).</p>\n<p dir=\"auto\">Hence, with this change, we will now also throw a <code class=\"notranslate\">ConnectionNotEstablished</code> by extending the already existing error message matching for when Postgres is down.</p>\n<h3 dir=\"auto\">Additional information</h3>\n<p dir=\"auto\">In this PR, we also use <code class=\"notranslate\">pg_terminate_backend</code> to recreate the database failover scenario in the test. Which would prompt <code class=\"notranslate\">pg</code> gem to throw <code class=\"notranslate\">PG::UnableToSend: server closed the connection unexpectedly</code>. Accordingly we retry and recover from the queries.</p>\n<p dir=\"auto\"><strong>Question</strong>: Should this change be logged in CHANGELOG?</p>\n<h3 dir=\"auto\">Checklist</h3>\n<p dir=\"auto\">Before submitting the PR make sure the following are checked:</p>\n<ul class=\"contains-task-list\">\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> This Pull Request is related to one change. Changes that are unrelated should be opened in separate PRs.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Commit message has a detailed description of what changed and why. If this PR fixes a related issue include it in the commit message. Ex: <code class=\"notranslate\">[Fix #issue-number]</code></li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> Tests are added or updated if you fix a bug or add a feature.</li>\n<li class=\"task-list-item\"><input type=\"checkbox\" id=\"\" disabled=\"\" class=\"task-list-item-checkbox\" checked=\"\"> CHANGELOG files are updated for the changed libraries if there is a behavior change or additional feature. Minor bug fixes and documentation changes should not be included.</li>\n</ul>",
            "url": "https://github.com/rails/rails/pull/48093",
            "title": "Raise retryable exception class on abrupt Postgres connection closure",
            "date_modified": "2023-05-05T11:54:08.000Z",
            "date_published": "2023-04-28T16:23:50.000Z",
            "author": {
                "name": "shayonj",
                "url": "https://github.com/shayonj"
            }
        }
    ]
}